name: Atualizar Badges do Credly (Script Python)

on:
  schedule:
    - cron: "0 0 * * *" # Roda todo dia √† meia-noite
  workflow_dispatch: # Permite rodar manualmente

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar depend√™ncias
        run: pip install requests beautifulsoup4

      - name: Rodar Script de Atualiza√ß√£o
        shell: python
        run: |
          import requests
          from bs4 import BeautifulSoup
          import sys

          # --- CONFIGURA√á√ÉO ---
          # Tente 'louise-carvalho' se 'louise-aldrighi' n√£o funcionar
          CREDLY_USER = "louise-aldrighi" 
          URL = f"https://www.credly.com/users/{CREDLY_USER}/badges#credly"
          
          print(f"--- INICIANDO ---")
          print(f"Alvo: {URL}")
          
          try:
              headers = {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
              }
              response = requests.get(URL, headers=headers)
              
              if response.status_code != 200:
                  print(f"ERRO: N√£o foi poss√≠vel acessar o perfil. Status Code: {response.status_code}")
                  sys.exit(1)
              
              soup = BeautifulSoup(response.text, 'html.parser')
              
              # Tenta encontrar badges (Credly muda as classes as vezes, ent√£o tentamos duas formas)
              badges = soup.find_all('div', class_='cr-standard-grid-item-content')
              if not badges:
                  print("Tentando seletor alternativo...")
                  badges = soup.find_all('div', attrs={'data-testid': 'badge-grid-item'})

              print(f"Badges encontradas: {len(badges)}")

              if len(badges) == 0:
                  print("ERRO CR√çTICO: Nenhuma badge encontrada. Verifique se o USU√ÅRIO est√° correto no script.")
                  sys.exit(0) # Sai sem erro para n√£o quebrar o workflow, mas avisa

              # Monta o HTML
              html_content = '<div align="center">\n'
              
              count = 0
              for badge in badges:
                  if count >= 5: break 
                  
                  img_tag = badge.find('img')
                  link_tag = badge.find('a')
                  
                  if img_tag and link_tag:
                      img_src = img_tag.get('src')
                      href = "https://www.credly.com" + link_tag.get('href', '')
                      title = img_tag.get('alt', 'Badge')
                      
                      if img_src:
                          html_content += f'  <a href="{href}" title="{title}"><img src="{img_src}" width="110" style="margin: 5px;"></a>\n'
                          count += 1
              
              html_content += '</div>'
              
              # Atualiza o README
              with open('README.md', 'r', encoding='utf-8') as f:
                  readme = f.read()
              
              start_marker = ""
              end_marker = ""
              
              if start_marker not in readme or end_marker not in readme:
                  print("ERRO: Marcadores n√£o encontrados no README.md. Adicione e ")
                  sys.exit(1)
              
              part1 = readme.split(start_marker)[0]
              part2 = readme.split(end_marker)[1]
              
              new_readme = f"{part1}{start_marker}\n{html_content}\n{end_marker}{part2}"
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(new_readme)
              
              print("SUCESSO: README atualizado!")

          except Exception as e:
              print(f"ERRO DE EXECU√á√ÉO: {e}")
              sys.exit(1)

      - name: Commit e Push das altera√ß√µes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ü§ñ Update: Certifica√ß√µes Credly (Script v2)"
