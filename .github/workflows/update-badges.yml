name: Atualizar Badges (Via API JSON)

on:
  schedule:
    - cron: "0 0 * * *" # Roda todo dia √† meia-noite
  workflow_dispatch: # Permite rodar manualmente

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar requests
        run: pip install requests

      - name: Rodar Script de Atualiza√ß√£o
        shell: python
        run: |
          import requests
          import sys

          # --- CONFIGURA√á√ÉO ---
          URL = "https://www.credly.com/users/louise-aldrighi/badges.json"
          
          print(f"--- CONSULTANDO API JSON ---")
          print(f"Alvo: {URL}")
          
          try:
              headers = {
                  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36"
              }
              
              response = requests.get(URL, headers=headers)
              
              if response.status_code != 200:
                  print(f"‚ùå Erro ao acessar a API: {response.status_code}")
                  sys.exit(1)
              
              data = response.json()
              badges_list = data.get('data', [])
              
              print(f"‚úÖ Sucesso! Encontrados {len(badges_list)} badges.")

              if not badges_list:
                  print("Aviso: Lista de badges retornou vazia.")
                  sys.exit(0)

              # --- MONTAGEM DO HTML ---
              html_content = '<div align="center">\n'
              
              count = 0
              for item in badges_list:
                  if count >= 8: break 
                  
                  badge_details = item.get('badge_template', {})
                  badge_id = item.get('id')
                  titulo = badge_details.get('name', 'Badge')
                  img_url = badge_details.get('image', {}).get('url')
                  public_link = f"https://www.credly.com/badges/{badge_id}"
                  
                  if img_url and badge_id:
                      html_content += f'  <a href="{public_link}" title="{titulo}"><img src="{img_url}" width="110" style="margin: 5px;"></a>\n'
                      count += 1
              
              html_content += '</div>'
              
              # --- ATUALIZA√á√ÉO DO README ---
              print("Lendo README.md...")
              with open('README.md', 'r', encoding='utf-8') as f:
                  readme = f.read()
              
              # --- O TRUQUE ANTI-BUG ---
              # Montamos a string somando peda√ßos para garantir que o texto n√£o suma
              start_marker = "<!" + "-- CREDLY-BADGES-START --" + ">"
              end_marker = "<!" + "-- CREDLY-BADGES-END --" + ">"
              
              if start_marker not in readme or end_marker not in readme:
                  print(f"‚ùå ERRO: Marcadores n√£o encontrados no README.")
                  print(f"Esperado: {start_marker} e {end_marker}")
                  sys.exit(1)
              
              part1 = readme.split(start_marker)[0]
              part2 = readme.split(end_marker)[1]
              
              new_readme = f"{part1}{start_marker}\n{html_content}\n{end_marker}{part2}"
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(new_readme)
              
              print("‚úÖ README atualizado com sucesso!")

          except Exception as e:
              print(f"‚ùå Ocorreu um erro cr√≠tico: {e}")
              sys.exit(1)

      - name: Commit e Push das altera√ß√µes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ü§ñ Update: Badges via API JSON"
